const NOTIFY = 'ops@pragatiecosolar.com'; // <-- your email
const SHEET_NAME = 'Installation Submissions';
const FOLDER_NAME = 'Pragati EcoSolar – Plant Photos';

function setup() {
  let ss;
  const files = DriveApp.getFilesByName('Pragati EcoSolar – Installation Submissions');
  ss = files.hasNext() ? SpreadsheetApp.open(files.next())
                       : SpreadsheetApp.create('Pragati EcoSolar – Installation Submissions');

  let sh = ss.getSheetByName(SHEET_NAME);
  if (!sh) sh = ss.insertSheet(SHEET_NAME); else sh.clear();
  sh.appendRow([
    'Timestamp','Customer Name','Contact Number','Address','District/Block','System Capacity (kW)','Date of Installation',
    'Installation Team Lead','Panel Brand & Model','Inverter Brand & Model','Structure Type','Tilt Angle (°)','Orientation',
    'Net Meter Installed','DISCOM Name','Panel Serials','Inverter Serials','DC Cable Brand','AC Cable Brand',
    'Installation Completed','Test Run Successful','Customer Signature Taken','Serials Verified','Remarks',
    'Installer Name','Installer Date','Customer Name (Ack)','Customer Date',
    'Sunoara 3KW ONGRID INVERTER (Nos)','Adani 550 (Nos)','STRUCTURE WITH CLAMPS (Set)','DCDB (INFI) (Nos)','ACDB (INFI) (Nos)',
    'DC 4 sqmm KEI (Meter)','AC 4sqmm Green Earthing (Meter)','AC 4sqmm Black INV-ACDB (Meter)','AC 4sqmm Red INV-ACDB (Meter)','1.1kV 16sqmm Alu Earthing (Meter)',
    'LA Rod w/ Stand (Nos)','Pit Cover (Nos)','MC4 Pair (Pairs)','Cable Tie 300mm (Packet)','25mm PVC Conduit (Nos)',
    'PVC Elbow (Nos)','PVC Tee (Nos)','25mm PVC C Clip (Nos)','35x8mm Screw+Grip (Nos)','4sqmm Ring Lugs (Nos)','6sqmm Pin Lugs (Nos)',
    '16sqmm Ring Lugs (Nos)','PVC Tape RGB (Nos)','Mid Clamp (Nos)','End Clamp (Nos)','Photo Links'
  ]);

  const found = DriveApp.getFoldersByName(FOLDER_NAME);
  const folder = found.hasNext() ? found.next() : DriveApp.createFolder(FOLDER_NAME);

  Logger.log('Sheet ready. URL: ' + ss.getUrl());
  Logger.log('Photo folder ready. URL: ' + folder.getUrl());
}

// NEW: so the Web App URL opens without error
function doGet(e) {
  const msg = 'Pragati EcoSolar Web App is live. Use your HTML form to POST here.';
  return ContentService.createTextOutput(msg)
                       .setMimeType(ContentService.MimeType.TEXT);
}

function doPost(e) {
  const p = e.parameter;
  const files = e.files || {};
  const photoLinks = [];

  const found = DriveApp.getFoldersByName(FOLDER_NAME);
  const folder = found.hasNext() ? found.next() : DriveApp.createFolder(FOLDER_NAME);

  Object.keys(files).forEach(k => {
    const blob = files[k];
    const created = folder.createFile(blob);
    created.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    photoLinks.push(created.getUrl());
  });

  const ss = SpreadsheetApp.open(DriveApp.getFilesByName('Pragati EcoSolar – Installation Submissions').next());
  const sh = ss.getSheetByName(SHEET_NAME);

  const panelSerials = Array.isArray(p['panel_serials[]']) ? p['panel_serials[]'].join('\n') : (p['panel_serials[]'] || '');
  const inverterSerials = Array.isArray(p['inverter_serials[]']) ? p['inverter_serials[]'].join('\n') : (p['inverter_serials[]'] || '');

  const row = [
    new Date(),
    p.customer_name||'', p.contact||'', p.address||'', p.district||'', p.capacity||'', p.install_date||'',
    p.team_lead||'', p.panel||'', p.inverter||'', p.structure||'', p.tilt||'', p.orientation||'',
    p.net_meter||'', p.discom||'',
    panelSerials, inverterSerials, p.dc_brand||'', p.ac_brand||'',
    p.done||'', p.test_run||'', p.signature_taken||'', p.serials_verified||'', p.remarks||'',
    p.installer_name||'', p.installer_date||'', p.customer_name_ack||'', p.customer_date||'',
    p.qty_inverter||'', p.qty_adani550||'', p.qty_structure||'', p.qty_dcdb||'', p.qty_acdb||'',
    p.qty_dc4kei||'', p.qty_ac4green||'', p.qty_ac4black||'', p.qty_ac4red||'', p.qty_alu16||'',
    p.qty_la||'', p.qty_pit||'', p.qty_mc4||'', p.qty_tie||'', p.qty_conduit||'',
    p.qty_elbow||'', p.qty_tee||'', p.qty_cclip||'', p.qty_screw||'', p.qty_lug4||'', p.qty_lug6||'',
    p.qty_lug16||'', p.qty_pvctape||'', p.qty_midclamp||'', p.qty_endclamp||'',
    photoLinks.join(', ')
  ];
  sh.appendRow(row);

  const html = `
    <h2>New Installation Completion</h2>
    <p><b>Customer:</b> ${p.customer_name} &nbsp; <b>Contact:</b> ${p.contact}</p>
    <p><b>Address:</b> ${p.address} | <b>District/Block:</b> ${p.district}</p>
    <p><b>Capacity:</b> ${p.capacity} kW &nbsp; <b>Install Date:</b> ${p.install_date}</p>
    <p><b>Team Lead:</b> ${p.team_lead}</p>
    <hr>
    <p><b>Panel:</b> ${p.panel} | <b>Inverter:</b> ${p.inverter}</p>
    <p><b>Structure:</b> ${p.structure} | <b>Tilt:</b> ${p.tilt}° | <b>Orientation:</b> ${p.orientation}</p>
    <p><b>Net Meter:</b> ${p.net_meter} | <b>DISCOM:</b> ${p.discom}</p>
    <p><b>Panel Serials:</b><br>${panelSerials.replace(/\n/g,'<br>')}</p>
    <p><b>Inverter Serials:</b><br>${inverterSerials.replace(/\n/g,'<br>')}</p>
    <p><b>DC Brand:</b> ${p.dc_brand} | <b>AC Brand:</b> ${p.ac_brand}</p>
    <p><b>Completed:</b> ${p.done} | <b>Test Run:</b> ${p.test_run} | <b>Customer Signature:</b> ${p.signature_taken} | <b>Serials Verified:</b> ${p.serials_verified}</p>
    <p><b>Remarks:</b> ${p.remarks||''}</p>
    <p><b>Photos:</b> ${photoLinks.map(u=>`<a href="${u}">photo</a>`).join(' | ')}</p>
  `;
  MailApp.sendEmail({ to: NOTIFY, subject: 'New Solar Installation Completion', htmlBody: html });

  return ContentService.createTextOutput('Thank you! Your submission has been recorded.')
                       .setMimeType(ContentService.MimeType.TEXT);
}
